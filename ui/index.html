<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoodBox Mini MVP (MovieLens)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 30px auto; padding: 0 16px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    select, input, button { padding: 8px 10px; font-size: 14px; }
    button { cursor: pointer; }
    ul { padding-left: 18px; }
    li { margin: 6px 0; }
    .meta { color: #666; font-size: 12px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-top: 12px; }
  </style>
</head>
<body>
  <h2>Mood-based Recommendations (MovieLens MVP)</h2>

  <div class="card">
    <div class="row">
      <label>Mood:</label>
      <select id="mood">
        <option value="calm">calm</option>
        <option value="fun" selected>fun</option>
        <option value="intense">intense</option>
        <option value="sad">sad</option>
        <option value="inspire">inspire</option>
      </select>

      <label>Top K:</label>
      <input id="k" type="number" value="5" min="1" max="50"/>

      <button id="btn">Get recommendations</button>
    </div>

    <p class="meta" id="status">Status: ready</p>
    <ul id="list"></ul>
  </div>

  <script>
    // API基础URL配置
    const API = "http://127.0.0.1:8000";

    /**
     * HTML转义函数，将特殊字符转换为HTML实体
     * @param {string} s - 需要转义的字符串
     * @returns {string} 转义后的字符串
     */
    function escapeHtml(s) {
      return s.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    /**
     * 异步加载推荐数据并更新页面显示
     * 从页面元素获取用户选择的情绪和top-k参数，调用API获取推荐结果，并更新状态和列表显示
     * @async
     * @returns {Promise<void>}
     */
    async function load() {
      // 获取用户输入的参数
      const mood = document.getElementById("mood").value;
      const k = document.getElementById("k").value || 5;
      const status = document.getElementById("status");
      const list = document.getElementById("list");

      // 更新状态为加载中
      status.textContent = "Status: loading...";
      list.innerHTML = "";

      try {
        // 构建API请求URL并发送请求
        const url = `${API}/recommendations?mood=${encodeURIComponent(mood)}&k=${encodeURIComponent(k)}`;
        const res = await fetch(url);
        const data = await res.json();

        // 更新状态信息显示
        status.textContent = `Status: ok | mood=${data.mood} | filter=${(data.genres_filter||[]).join(",")}`;

        // 遍历推荐结果并生成列表项
        (data.items || []).forEach((x, idx) => {
          const li = document.createElement("li");
          li.innerHTML =
            `<b>#${idx+1}</b> ${escapeHtml(x.title)} ` +
            `<span class="meta">(${escapeHtml(x.genres)} | score=${Number(x.weighted_rating).toFixed(3)} | n=${x.rating_count})</span>`;
          list.appendChild(li);
        });
      } catch (e) {
        // 错误处理：显示错误信息
        status.textContent = "Status: error - " + e;
      }
    }

    // 为按钮添加点击事件监听器，并初始化加载一次数据
    document.getElementById("btn").addEventListener("click", load);
    load();
  </script>
</body>
</html>

